/*
 * The MIT License (MIT)
 * 
 * Copyright (c) 2014 Stefan Dollase
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function AppStateBinder(e){var t=this;this.ignoreExportCurrentState=false;this.ignoreFireChangedCounter=0;this.appState={};this.setupAppState(e);this.registerHashChanged(function(){t.hashChanged(t)});this.ignoreFireChanged(true);this.hashChanged();this.ignoreFireChanged(false)}AppStateBinder.prototype.registerHashChanged=function(e){if(!("onhashchange"in window)){var t=location.href;window.setInterval(function(){var n=location.href;if(t!==n){var r=t;t=n;e.call(window,{type:"hashchange",newURL:n,oldURL:r})}},100)}else if(window.addEventListener){window.addEventListener("hashchange",e,false)}else if(window.attachEvent){window.attachEvent("onhashchange",e)}};AppStateBinder.prototype.getHash=function(){var e=window.location.hash;if(e.length>0){if(e.substring(0,1)==="#"){e=e.substring(1)}}else{e=""}return e};AppStateBinder.prototype.hashChanged=function(){if(this.ignoreChangeOnce){this.ignoreChangeOnce=false;return}this.parseHash()};AppStateBinder.prototype.parseHash=function(){this.ignoreExportCurrentState=true;this.ignoreFireChanged(true);var e=this.getHash();var t=e.split("|");var n=this.getNames();var r={};for(var i=0;i<t.length;i++){if(t[i]===""){}else{var s=this.parseHashEntry(t[i]);if(s!==false){delete n[s]}}}for(var o in n){this.unset(o)}this.ignoreFireChanged(false);this.ignoreExportCurrentState=false;this.fireChangedForCache()};AppStateBinder.prototype.getNames=function(){var e={};for(var t in this.appState){e[t]=true}return e};AppStateBinder.prototype.parseHashEntry=function(e){var t;for(var n in this.appState){t=this.appState[n].parse(e);if(t!==false){this.set(n,t);return n}}return false};AppStateBinder.prototype.exportCurrentState=function(){if(this.ignoreExportCurrentState){return}var e="";for(var t in this.appState){if(this.appState[t].stringValue!==false){e+="|"+this.appState[t].stringValue}}var n=e.substring(1);if(n===this.getHash()){this.ignoreChangeOnce=false}else{this.ignoreChangeOnce=true;window.location.hash=n}};AppStateBinder.prototype.fireChangedForAll=function(){for(var e in this.appState){this.fireChanged(e)}};AppStateBinder.prototype.fireChangedForCache=function(){for(var e in this.fireChangedCache){this.fireChanged(e)}};AppStateBinder.prototype.fireChanged=function(e){if(this.ignoreFireChangedCounter>0){this.fireChangedCache[e]=true}else{this.appState[e].changed(this.get(e))}};AppStateBinder.prototype.setStringValue=function(e,t,n){var r=this.appState[e].stringValue;var i=this.appState[e].parse(t);if(i!==false){this.appState[e].dataValue=i;this.appState[e].stringValue=this.appState[e].stringify(i)}if(n||r!==this.appState[e].stringValue){this.exportCurrentState();this.fireChanged(e)}};AppStateBinder.prototype.set=function(e,t,n){var r=this.appState[e].stringValue;this.appState[e].dataValue=t;this.appState[e].stringValue=this.appState[e].stringify(t);if(n||r!==this.appState[e].stringValue){this.exportCurrentState();this.fireChanged(e)}};AppStateBinder.prototype.toggle=function(e){if(this.appState[e].type==="flag"){this.set(e,!this.isSet(e))}else if(this.appState[e].type==="option"){var t=this.appState[e].options;var n=this.indexOf(t,this.get(e));var r=(n+1)%t.length;this.set(e,t[r])}else{throw"cannot toggle "+e}};AppStateBinder.prototype.unset=function(e){var t=this.appState[e].stringValue;this.appState[e].dataValue=false;this.appState[e].stringValue=false;if(t!==this.appState[e].stringValue){this.fireChanged(e);this.exportCurrentState()}};AppStateBinder.prototype.isSet=function(e){return this.appState[e].dataValue!==false};AppStateBinder.prototype.getStringValue=function(e,t){if(this.isSet(e)){return this.appState[e].stringValue}else if(t===undefined){return false}else{return t}};AppStateBinder.prototype.get=function(e,t){if(this.isSet(e)){return this.appState[e].dataValue}else if(t===undefined){return false}else{return t}};AppStateBinder.prototype.setupAppState=function(e){for(var t in e){if(this.knownTypes.hasOwnProperty(e[t].type)){this.appState[t]=this.knownTypes[e[t].type].call(this,t,e[t]);this.appState[t].name=t;this.appState[t].type=e[t].type;this.appState[t].changed=e[t].changed;this.appState[t].dataValue=false;this.appState[t].stringValue=false}else{throw"unknown type"}}};AppStateBinder.prototype.knownTypes={custom:function(e,t){return{parse:t.parse,stringify:t.stringify}},flag:function(e,t){return{parse:function(t){if(t===e){return true}else{return false}},stringify:function(t){if(t===true){return e}else{return false}}}},option:function(e,t){return{options:t.options,parse:function(e){for(var n=0;n<t.options.length;n++){if(e===t.options[n]){return e}}return false},stringify:function(e){for(var n=0;n<t.options.length;n++){if(e===t.options[n]){return e}}return false}}},json:function(e,t){return{parse:function(e){try{return JSON.parse(e)}catch(t){return false}},stringify:function(e){if(e===false){return false}else{return JSON.stringify(e)}}}},number:function(e,t){var n=this.parseRegexRanges([t.prefix,t.suffix],["result"],{result:[t.min,t.max]});return{prefix:t.prefix,suffix:t.suffix,min:t.min,max:t.max,parse:function(e){var t=n(e);if(t===false){return false}else{return t.result}},stringify:function(e){if(e===false){return false}else{return t.prefix+e+t.suffix}}}},numberObject:function(e,t){return{separators:t.separators,attributes:t.attributes,ranges:t.ranges,parse:this.parseRegexRanges(t.separators,t.attributes,t.ranges),stringify:function(e){if(e===false){return false}else{var n="";if(t.separators.length>0){n+=t.separators[0];for(var r=1;r<t.separators.length&&r<=t.attributes.length;r++){n+=e[t.attributes[r-1]]+t.separators[r]}}return n}}}}};AppStateBinder.prototype.parseIntMinMax=function(e,t,n){if(e===""||isNaN(e)){throw"NaN"}var r=parseInt(e);if(r<t){r=t}else if(r>n){r=n}return r};AppStateBinder.prototype.escapeRegex=function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")};AppStateBinder.prototype.buildNumberRegex=function(e){var t="^";if(e.length>0){t+=this.escapeRegex(e[0]);for(var n=1;n<e.length;n++){t+="(-?\\d+)"+this.escapeRegex(e[n])}}return new RegExp(t+"$")};AppStateBinder.prototype.parseRegex=function(e,t,n){var r=e.match(t);if(r===null){return false}var i={};for(var s=1;s<r.length&&s<=n.length;s++){i[n[s-1]]=r[s]}return i};AppStateBinder.prototype.parseIntMinMaxObject=function(e,t){try{for(var n in t){e[n]=this.parseIntMinMax(e[n],t[n][0],t[n][1])}return e}catch(r){return false}};AppStateBinder.prototype.parseRegexRanges=function(e,t,n){var r=this.buildNumberRegex(e);var i=this;return function(e){var s=i.parseRegex(e,r,t);if(s===false){return false}else{return i.parseIntMinMaxObject(s,n)}}};AppStateBinder.prototype.indexOf=function(e,t){for(var n=0;n<e.length;n++){if(e[n]===t){return n}}return-1};AppStateBinder.prototype.ignoreFireChanged=function(e){if(e){if(this.ignoreFireChangedCounter===0){this.fireChangedCache={}}this.ignoreFireChangedCounter++}else{this.ignoreFireChangedCounter--}}